<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MusiCat Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: linear-gradient(45deg, #444444, #0e0e0e, #444444);
      background-size: 400% 400%;
      animation: moveBg 15s linear infinite;
      font-family: 'Poppins', sans-serif;
    }

    @keyframes moveBg {
      0% { background-position: 0% 50%; }
      100% { background-position: 100% 50%; }
    }

    .bubble-pop { animation: popIn 0.5s ease-out; }
    @keyframes popIn {
      0% { transform: scale(0.85); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }

    .neon-border {
      border: 5px solid transparent;
      border-radius: 1rem;
      background-clip: padding-box;
      position: relative;
    }

    .neon-border::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: 1rem;
      padding: 2px;
      background: linear-gradient(45deg, #02f5cc, #03eeff, #00ffb2);
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: destination-out;
      mask-composite: exclude;
      z-index: -1;
    }

    iframe { border: none; }
  </style>
</head>
<body class="text-white min-h-screen flex flex-col">

  <!-- Navbar -->
  <div class="navbar bg-black bg-opacity-70 flex justify-between items-center px-4 py-4 sticky top-0 z-10">
    <div class="flex items-center gap-4">
      <button class="md:hidden focus:outline-none" id="menu-toggle">
        <svg class="w-6 h-6 text-cyan-400" fill="none" stroke="currentColor" stroke-width="2"
             viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
          <path d="M4 6h16M4 12h16M4 18h16"/>
        </svg>
      </button>
      <h1 class="text-2xl md:text-3xl font-extrabold bg-gradient-to-r from-cyan-400 to-green-400 text-transparent bg-clip-text">MusiCat</h1>
    </div>
    <div class="flex flex-wrap gap-2 text-sm md:text-base">
      <a href="https://vyxm.in" class="hover:bg-cyan-700 px-3 py-1 rounded-full">Home</a>
      <a href="https://vyxm.in/musicat" class="hover:bg-teal-600 px-3 py-1 rounded-full">About</a>
      <a href="https://github.org/Vyomie/MusiCat" class="hover:bg-green-500 px-3 py-1 rounded-full">Docs</a>
    </div>
  </div>

  <div class="flex flex-1 flex-col md:flex-row overflow-hidden">

    <!-- Sidebar: hidden on mobile, visible on md+ -->
    <aside id="sidebar" class="w-full md:w-44 bg-gradient-to-b from-blue-500 via-blue-600 to-green-600 p-4 space-y-4 overflow-y-auto md:block hidden">
      <h2 class="text-lg font-semibold text-white">Playlists</h2>
      <div id="playlist-sidebar" class="space-y-4"></div>
    </aside>

    <!-- Chat Area -->
    <main class="flex-1 flex flex-col justify-between p-3 md:p-4 overflow-hidden">
      <div class="w-full flex flex-col h-full rounded-2xl shadow-lg neon-border">
        <div id="chat-box" class="flex-1 overflow-y-auto space-y-4 p-3"></div>

        <!-- Input Section -->
        <div class="p-2">
          <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 items-stretch sm:items-center">
            <input id="user-input" type="text" placeholder="Ask something..."
              class="flex-1 bg-gray-700 text-white border border-gray-600 rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-cyan-400 disabled:opacity-50" />
            <button id="send-btn" onclick="sendMessage()" class="w-full sm:w-10 h-10">
              <img src="https://cdn-icons-png.flaticon.com/512/724/724715.png" alt="Send" class="w-full h-full object-contain" />
            </button>
          </div>
          <div id="loading" class="mt-2 hidden text-center text-gray-400">
            <div class="flex justify-center items-center space-x-2">
              <svg class="animate-spin h-5 w-5 text-cyan-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8H4z"></path>
              </svg>
              <span>Just wait for some time cutie <3</span>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    const input = document.getElementById("user-input");
    const chatBox = document.getElementById("chat-box");
    const loading = document.getElementById("loading");
    const sendBtn = document.getElementById("send-btn");
    const playlistSidebar = document.getElementById("playlist-sidebar");
    const menuToggle = document.getElementById("menu-toggle");
    const sidebar = document.getElementById("sidebar");

    menuToggle.addEventListener("click", () => {
      sidebar.classList.toggle("hidden");
    });

    const getPlaylists = () => JSON.parse(localStorage.getItem("savedPlaylists") || "[]");

    const savePlaylist = (url, image) => {
      const existing = getPlaylists();
      if (!existing.find(p => p.url === url)) {
        existing.push({ url, image });
        localStorage.setItem("savedPlaylists", JSON.stringify(existing));
        addPlaylistToSidebar(url, image);
      }
    };

    const addPlaylistToSidebar = (url, image) => {
      const div = document.createElement("div");
      div.className = "cursor-pointer group sidebar-thumbnail";
      div.innerHTML = `
        <div class="overflow-hidden rounded-xl shadow-lg transform hover:scale-105 transition duration-300">
          <img src="${image}" alt="Playlist" />
        </div>
        <p class="text-xs text-white mt-1 truncate">${url.split('/playlist/')[1].split('?')[0]}</p>`;
      div.onclick = () => loadPlaylist(url);
      playlistSidebar.appendChild(div);
    };

    const loadPlaylist = (url) => {
      const playlistId = url.split("/playlist/")[1].split("?")[0];
      const embedUrl = `https://open.spotify.com/embed/playlist/${playlistId}?utm_source=generator`;

      const msg = document.createElement("div");
      msg.className = "flex justify-start items-start bubble-pop";
      msg.innerHTML = `
        <div class="flex items-start space-x-2">
          <img src="https://cdn-icons-png.flaticon.com/512/4712/4712104.png" class="w-8 h-8 rounded-full" alt="Bot">
          <div class="max-w-xs bg-gray-700 text-white p-3 rounded-xl neon-border">
            <iframe style="border-radius:12px"
              src="${embedUrl}"
              width="100%" height="152"
              allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
              loading="lazy"></iframe>
          </div>
        </div>`;
      chatBox.appendChild(msg);
      chatBox.scrollTop = chatBox.scrollHeight;
    };

    const loadSavedPlaylists = () => {
      getPlaylists().forEach(({ url, image }) => addPlaylistToSidebar(url, image));
    };

    async function sendMessage() {
      const userText = input.value.trim();
      if (!userText) return;

      input.disabled = true;
      sendBtn.disabled = true;

      const userMsg = document.createElement("div");
      userMsg.className = "flex justify-end items-start bubble-pop";
      userMsg.innerHTML = `
        <div class="flex items-end space-x-2">
          <div class="max-w-xs bg-cyan-600 text-white p-3 rounded-xl neon-border">
            <div>${userText}</div>
          </div>
          <img src="https://i.pinimg.com/474x/47/ba/71/47ba71f457434319819ac4a7cbd9988e.jpg" class="w-8 h-8 rounded-full" alt="User">
        </div>`;
      chatBox.appendChild(userMsg);
      chatBox.scrollTop = chatBox.scrollHeight;

      loading.classList.remove("hidden");

      try {
        const formattedInput = userText.replace(/ /g, "+");
        const res = await fetch(`https://api.vyxm.in/mcat?input=${formattedInput}`);
        const text = await res.text();
        const txt = JSON.parse(text);

        let content;

        if (txt['response']?.startsWith("https://open.spotify.com/playlist/")) {
          const url = txt['response'];
          const playlistId = url.split("/playlist/")[1].split("?")[0];
          const oembed = await fetch(`https://open.spotify.com/oembed?url=${url}`);
          const meta = await oembed.json();
          const image = meta.thumbnail_url;

          savePlaylist(url, image);

          const embedUrl = `https://open.spotify.com/embed/playlist/${playlistId}?utm_source=generator`;
          content = `
            <iframe style="border-radius:12px"
              src="${embedUrl}"
              width="100%" height="152"
              allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
              loading="lazy"></iframe>`;
        } else {
          content = `<div>${txt['response']}</div>`;
        }

        const botMsg = document.createElement("div");
        botMsg.className = "flex justify-start items-start bubble-pop";
        botMsg.innerHTML = `
          <div class="flex items-start space-x-2">
            <img src="https://cdn-icons-png.flaticon.com/512/4712/4712104.png" class="w-8 h-8 rounded-full" alt="Bot">
            <div class="max-w-xs bg-gray-700 text-white p-3 rounded-xl neon-border">
              ${content}
            </div>
          </div>`;
        chatBox.appendChild(botMsg);

      } catch (err) {
        const errMsg = document.createElement("div");
        errMsg.className = "flex justify-start bubble-pop";
        errMsg.innerHTML = `
          <div class="max-w-xs bg-red-600 text-white p-3 rounded-xl neon-border">
            <div>⚠️ Oops! Something went wrong.</div>
          </div>`;
        chatBox.appendChild(errMsg);
      } finally {
        loading.classList.add("hidden");
        input.value = "";
        input.disabled = false;
        sendBtn.disabled = false;
        chatBox.scrollTop = chatBox.scrollHeight;
      }
    }

    input.addEventListener("keypress", function(e) {
      if (e.key === "Enter" && !input.disabled) sendMessage();
    });

    window.onload = loadSavedPlaylists;
  </script>
</body>
</html>
